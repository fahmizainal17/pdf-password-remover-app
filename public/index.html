<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDF Password Remover App</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>PDF Password Remover</h1>

  <input type="file" id="fileInput" multiple accept=".pdf"/>

  <div class="pwd-wrapper">
    <input type="password" id="pwdInput" placeholder="Enter password" />
    <button id="togglePwd">Show</button>
  </div>

  <button id="go">Unlock PDFs</button>

  <script>
    const fileInput = document.getElementById('fileInput');
    const pwdInput  = document.getElementById('pwdInput');
    const togglePwd = document.getElementById('togglePwd');
    const goBtn     = document.getElementById('go');

    // Helper: read a File into a Base64 string
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          // reader.result => "data:application/pdf;base64,JVBERi0xLjcKJ..."
          const [, payload] = reader.result.split(',');
          resolve(payload);
        };
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    // Show / hide password
    togglePwd.addEventListener('click', () => {
      const isHidden = pwdInput.type === 'password';
      pwdInput.type  = isHidden ? 'text' : 'password';
      togglePwd.textContent = isHidden ? 'Hide' : 'Show';
    });

    goBtn.addEventListener('click', async () => {
      const files    = Array.from(fileInput.files);
      const password = pwdInput.value.trim();
      if (!files.length) return alert('Select at least one PDF.');
      if (!password)   return alert('Enter the PDF password.');

      for (const file of files) {
        try {
          // safely get Base64
          const fileBase64 = await fileToBase64(file);

          // call Netlify Function
          const res = await fetch('/.netlify/functions/remove-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fileBase64, password })
          });

          const { unlockedBase64, error } = await res.json();
          if (error) throw new Error(error);

          // download the unlocked PDF
          const blobUrl = `data:application/pdf;base64,${unlockedBase64}`;
          const a       = document.createElement('a');
          a.href        = blobUrl;
          a.download    = `unlocked_${file.name}`;
          document.body.appendChild(a);
          a.click();
          a.remove();
        } catch (err) {
          console.error(err);
          alert(`Error unlocking ${file.name} â€“ ${err.message}`);
        }
      }
    });
  </script>
</body>
</html>
